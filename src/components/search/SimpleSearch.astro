---
import { getLangFromUrl, useTranslations } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<div class="relative">
  <!-- Botón de búsqueda -->
  <button
    id="simple-search-button"
    class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-accent dark:hover:text-secondary transition-colors duration-200"
    aria-label={t('search.placeholder')}
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-5 w-5 mr-1"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
      />
    </svg>
    <span class="hidden sm:inline">{t('search.button')}</span>
  </button>

  <!-- Modal de búsqueda -->
  <div
    id="simple-search-modal"
    class="fixed inset-0 z-50 hidden overflow-y-auto bg-black bg-opacity-50"
  >
    <div class="flex min-h-screen items-center justify-center p-4">
      <div
        class="relative w-full max-w-2xl transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 p-6 text-left shadow-xl"
      >
        <div class="mb-4 flex items-center justify-between">
          <h3 class="text-lg font-medium text-gray-900 dark:text-white">
            {lang === 'es' ? 'Buscar en el blog' : 'Search the blog'}
          </h3>
          <button id="simple-search-close" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <!-- Campo de búsqueda simple -->
        <div class="mb-4">
          <input
            type="text"
            id="simple-search-input"
            class="w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-4 py-2 text-gray-900 dark:text-white focus:border-accent dark:focus:border-secondary focus:outline-none"
            placeholder={lang === 'es' ? 'Buscar artículos...' : 'Search articles...'}
          />
        </div>

        <!-- Resultados de búsqueda -->
        <div id="simple-search-results" class="max-h-[60vh] overflow-y-auto"></div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('astro:page-load', () => {
    // Elementos del DOM
    const searchButton = document.getElementById('simple-search-button');
    const searchModal = document.getElementById('simple-search-modal');
    const closeButton = document.getElementById('simple-search-close');
    const searchInput = document.getElementById('simple-search-input');
    const searchResults = document.getElementById('simple-search-results');

    // Configuración de Algolia
    const appId = 'ECFPLTCVYS';
    const apiKey = '463072454d6fd853983fceec6f91f12a';
    const indexName = 'cronometras_blog';

    // Obtener el idioma actual de la URL
    const pathSegments = window.location.pathname.split('/').filter(Boolean);
    const currentLang = pathSegments[0] === 'es' || pathSegments[0] === 'en' ? pathSegments[0] : 'es';

    // Función para abrir el modal
    function openSearchModal() {
      if (searchModal) {
        searchModal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
        
        // Enfocar el campo de búsqueda
        if (searchInput) {
          setTimeout(() => {
            searchInput.focus();
          }, 100);
        }
      }
    }

    // Función para cerrar el modal
    function closeSearchModal() {
      if (searchModal) {
        searchModal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
        
        // Limpiar resultados
        if (searchResults) {
          searchResults.innerHTML = '';
        }
        
        // Limpiar campo de búsqueda
        if (searchInput) {
          searchInput.value = '';
        }
      }
    }

    // Función para realizar la búsqueda
    async function performSearch(query) {
      if (!query.trim()) {
        if (searchResults) {
          searchResults.innerHTML = '';
        }
        return;
      }

      try {
        // Cargar algoliasearch si no está disponible
        if (!window.algoliasearch) {
          console.log('Cargando algoliasearch dinámicamente');
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js';
          document.head.appendChild(script);
          
          // Esperar a que se cargue
          await new Promise(resolve => {
            script.onload = resolve;
          });
        }
        
        // Inicializar cliente de Algolia
        const searchClient = window.algoliasearch(appId, apiKey);
        const index = searchClient.initIndex(indexName);
        
        // Realizar búsqueda
        const { hits } = await index.search(query, {
          hitsPerPage: 10,
          filters: `lang:${currentLang}`,
          attributesToHighlight: ['title', 'description', 'content'],
          attributesToSnippet: ['content:30'],
        });
        
        // Mostrar resultados
        if (searchResults) {
          if (hits.length === 0) {
            searchResults.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center py-4">
              ${currentLang === 'es' ? 'No se encontraron resultados.' : 'No results found.'}
            </p>`;
            return;
          }
          
          const resultsHTML = hits.map(hit => `
            <a href="/${currentLang}/blog/${hit.slug}" class="block p-4 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md mb-2">
              <div class="flex items-start">
                <div class="flex-shrink-0 mr-4">
                  <img src="${hit.heroImage || '/images/webp/default.webp'}" alt="${hit.title}" width="60" height="60" class="rounded-md">
                </div>
                <div>
                  <h4 class="text-gray-900 dark:text-white font-medium">${hit._highlightResult?.title?.value || hit.title}</h4>
                  <p class="text-gray-600 dark:text-gray-300 text-sm mt-1">${hit._highlightResult?.description?.value || hit.description}</p>
                  <div class="flex items-center mt-2">
                    <span class="text-xs text-accent dark:text-secondary font-medium">${hit.category}</span>
                    <span class="text-xs text-gray-500 dark:text-gray-400 ml-2">
                      ${new Date(hit.pubDate).toLocaleDateString(currentLang === 'es' ? 'es-ES' : 'en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                      })}
                    </span>
                  </div>
                </div>
              </div>
            </a>
          `).join('');
          
          searchResults.innerHTML = resultsHTML;
        }
      } catch (error) {
        console.error('Error al realizar la búsqueda:', error);
        if (searchResults) {
          searchResults.innerHTML = `<p class="text-red-500 dark:text-red-400 text-center py-4">
            ${currentLang === 'es' ? 'Error al realizar la búsqueda.' : 'Error performing search.'}
          </p>`;
        }
      }
    }

    // Event listeners
    if (searchButton) {
      searchButton.addEventListener('click', openSearchModal);
    }

    if (closeButton) {
      closeButton.addEventListener('click', closeSearchModal);
    }

    // Cerrar con Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && searchModal && !searchModal.classList.contains('hidden')) {
        closeSearchModal();
      }
    });

    // Cerrar al hacer clic fuera del modal
    searchModal?.addEventListener('click', (e) => {
      if (e.target === searchModal) {
        closeSearchModal();
      }
    });

    // Búsqueda en tiempo real
    if (searchInput) {
      let debounceTimer;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          performSearch(e.target.value);
        }, 300);
      });
    }
  });
</script>

<style>
  /* Estilos para los resultados destacados */
  :global(em) {
    background-color: rgba(255, 255, 0, 0.3);
    font-style: normal;
  }
  
  :global(.dark em) {
    background-color: rgba(255, 255, 0, 0.2);
  }
</style>
